function onOpen(e) {
  SpreadsheetApp.getUi().createAddonMenu()
  .addItem("Create Show", "createShowSidebar").addSeparator()
  .addItem("Add Cast and Crew", "createCastCrewSidebar")
  .addItem("Remove Students", "createRemoveStuSidebar")
  .addItem("Add Roles and Positions", "addRolePosSidebar")
  .addItem("Update Contact Information", "updateAllContactInfo").addSeparator()
  .addItem("Send Email", "createEmailSidebar")
  .addItem("T-Shirt Size Count", "countSizes")
  .addItem("Phone Numbers", "phoneList").addToUi();
}

function onInstall(e){
  onOpen(e);
}

function createShowSidebar() {
  var ui = HtmlService.createHtmlOutputFromFile("createshow").setTitle("Create Show");
  SpreadsheetApp.getUi().showSidebar(ui);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function createShow(showData) {
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetNames = ["Cast Info", "Crew Info", "Cast List", "Crew List", "Cast Points", "Crew Points"];
  var sheets = ss.getSheets();
  var ogSheet = sheets[0];
  ss.setActiveSheet(ogSheet);
  ss.renameActiveSheet("tmp");
  
  Logger.log(ogSheet);
  
  for (var i = 1; i < sheets.length; i++) {
    ss.deleteSheet(sheets[i]);
  }
  
  ss.rename(showData.name + " Cast and Crew");
  Logger.log(sheetNames);
  
  for (var k = 0; k < sheetNames.length; k++) {
    Logger.log(k);
    ss.insertSheet(sheetNames[k], k);
    Logger.log("Inserted: " + sheetNames[k]);
  }
  
  ss.deleteSheet(ogSheet);
  
  var castInfo = ss.getSheetByName("Cast Info");
  var crewInfo = ss.getSheetByName("Crew Info");
  var castList = ss.getSheetByName("Cast List");
  var crewList = ss.getSheetByName("Crew List");
  var castPoints = ss.getSheetByName("Cast Points");
  var crewPoints = ss.getSheetByName("Crew Points");
  
  setupInfo(castInfo);
  setupInfo(crewInfo);
  setupList(castList);
  setupList(crewList);
  setupPoints(castPoints, showData);
  setupPoints(crewPoints, showData);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function setupInfo(sheet) {
 
  var colName;
  
  if (sheet.getName().toLowerCase().indexOf("cast") !== -1) {
    colName = "Role"; 
  } else {
    colName = "Position";
  }
  
  sheet.appendRow([colName, "Name", "Grade", "Email", "Phone", "T-Shirt Size"]);
  boldIt(sheet);
  
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 50);
  sheet.setColumnWidth(4, 200);
  sheet.setColumnWidth(5, 90);
  sheet.setColumnWidth(6, 80);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function setupList(sheet) {
  
  var colName;
  
  if (sheet.getName().toLowerCase().indexOf("cast") !== -1) {
    colName = "Role"; 
  } else {
    colName = "Position";
  }
  
  sheet.appendRow([colName, "Names"]);
  boldIt(sheet);
  
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 500);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function setupPoints(sheet, showData) {
 
  var colName;
  var rolePosition;
  
  if (sheet.getName().toLowerCase().indexOf("cast") !== -1) {
    colName = "Role";
    rolePosition = showData.roleData;
  } else {
    colName = "Position";
    rolePosition = showData.positionData;
  }
  
  sheet.appendRow(["Number of Shows:", showData.numOfShows]);
  sheet.appendRow([colName, "Thespian Denomination"]);
  boldIt(sheet);
  
  for (var i=0; i<rolePosition.length; i++) {
    sheet.appendRow([rolePosition[i][0], rolePosition[i][1]]);
  }
  
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 200);
  
  sheet.getDataRange().setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function addRolePos(rolePosList) {
  
  Logger.log(rolePosList);
  
  if (rolePosList[0] == "role") {
    var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Cast Points");
  } else {
    var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Crew Points");
  }
  
  for (var i=0; i<rolePosList[1].length; i++) {
    Logger.log([rolePosList[1][i][0], rolePosList[1][i][1]]);
    ss.appendRow([rolePosList[1][i][0], rolePosList[1][i][1]]);
  }
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function boldIt(sheet) {
  sheet.getDataRange().setFontWeight("bold");
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function createCastCrewSidebar() {
  var ui = HtmlService.createHtmlOutputFromFile("addcastcrew").setTitle("Add Cast and Crew");
  SpreadsheetApp.getUi().showSidebar(ui);  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function compileStuNameList() {
  
  var dataSheet = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/1pGFH8ap2ufeOtTaBRwRNJYbtWYJ9H7_kr_RfxlsPPtU/edit?usp=drive_web&ouid=114301735813714623852");
  var data = dataSheet.getActiveSheet().getDataRange().getValues();
  data = data.splice(1, data.length);
  
  var nameList = [];
  var first;
  var last;
  
  for (var i=0; i<data.length; i++) {
    first = data[i][1].trim();
    last = data[i][2].trim();
    nameList.push(first + " " + last);
  }
  
  Logger.log(nameList.sort());
  return nameList.sort();
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function compileThespianDenomList() {
  
  var dataSheet = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/1TScK-pvRrMSdSB6Zj7meVCVj2vmjuisCR07Tw800rbg/edit#gid=0");
  var data = dataSheet.getActiveSheet().getDataRange().getValues();
  data = data.splice(1, data.length);
  //Logger.log(data);
  
  var denomList = [];
  var denomType;
  var denom;
  var oneActPts;
  var fullShowPts;
  var found = false;
  
  function denomTypeContainer(dType, curDenom) {
    this.name = dType;
    this.denoms = [curDenom];
  }
  
  for (var i=0; i<data.length; i++) {
    denomType = data[i][0].trim();
    Logger.log(denomType);
    denom = data[i][1].trim();
    //Logger.log(denom);
    oneActPts = parseInt(data[i][2]);
    fullShowPts = parseInt(data[i][3]);
    for (var j=0; j<denomList.length; j++) {
      if (denomList[j].name == denomType) {
        //Logger.log(denom);
        denomList[j].denoms.push([denom, oneActPts, fullShowPts]);
        found = true;
        break;
      }
    }
    if (!found) {
      denomList.push(new denomTypeContainer(denomType, [denom, oneActPts, fullShowPts]));
      Logger.log(denomList);
    }
    found = false;
  }
  
  Logger.log(denomList);
  return denomList;
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function compileRolePosList(sheetName) {

  var dataSheet = SpreadsheetApp.getActiveSpreadsheet();
  var data = dataSheet.getSheetByName(sheetName).getDataRange().getValues();
  data = data.splice(2, data.length);
  
  var rolePosList = [];
  
  for (var i=0; i<data.length; i++) {
    rolePosList.push(data[i][0]);
  }
  
  return rolePosList;
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function compileLists() {
  var nameList = compileStuNameList();
  var roleList = compileRolePosList("Cast Points");
  var positionList = compileRolePosList("Crew Points");
  Logger.log[nameList, roleList, positionList];
  return [nameList, roleList, positionList];
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function addCastCrew(castOrCrewSheet, role, numOfStu, names) {
  
  Logger.log(castOrCrewSheet.toString() +"\n"+ role.toString() +"\n"+ numOfStu.toString() +"\n"+ names.toString());
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var listSheet = ss.getSheetByName(castOrCrewSheet);
  var listSheetRange = listSheet.getDataRange();
  var sheetData = listSheetRange.getValues();
  sheetData = sheetData.slice(1, sheetData.length);
  var nameString = "";
  var curRng;
  var curValues;
  var roleNotPresent = true;
  
  for (var i=0; i<names.length; i++) {
    nameString = nameString + names[i].toString() + ", ";
  }
  
  for (var i=0; i<sheetData.length; i++) {
    if (role.toLowerCase() == sheetData[i][0].toLowerCase()) {
      curRng = listSheet.getRange(i+2, 2);
      curValues = curRng.getValue();
      if (curValues.length > 0) {
        curValues += ", ";
      }
      curValues = curValues + nameString;
      curRng.setValue(curValues.slice(0, curValues.length-2));
      roleNotPresent = false;
      break;
    }
  }
  
  if (roleNotPresent) {
    listSheet.appendRow([role, nameString.slice(0, nameString.length-2)]);
  }
  
  listSheet.getDataRange().setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP);
  SpreadsheetApp.setActiveSheet(listSheet);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function addRolePosSidebar() {
  
  var ui = HtmlService.createHtmlOutputFromFile("addrolepos").setTitle("Add Roles or Positions");
  SpreadsheetApp.getUi().showSidebar(ui);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function createRemoveStuSidebar() {
 
  var ui = HtmlService.createHtmlOutputFromFile("removestudents").setTitle("Remove Students");
  SpreadsheetApp.getUi().showSidebar(ui);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function removeStu() {
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function updateAllContactInfo() {
  updateContactInfo("Cast List", "Cast Info", "Role");
  updateContactInfo("Crew List", "Crew Info", "Position");
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function updateContactInfo(listName, infoName, colName) {
  
  var listSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(listName);
  var infoSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(infoName);
  var regSheet = SpreadsheetApp.openByUrl("https://docs.google.com/spreadsheets/d/1pGFH8ap2ufeOtTaBRwRNJYbtWYJ9H7_kr_RfxlsPPtU/edit#gid=2060589657").getActiveSheet();
  var listData = listSheet.getDataRange().getValues();
  var regData = regSheet.getDataRange().getValues();
  var ui = SpreadsheetApp.getUi();
  
  listData = listData.slice(1, listData.length);
  regData = regData.slice(1, regData.length);
  
  var row;
  var role;
  var nameList;
  var usedNameList = [];
  var name;
  var firstNlast;
  var notFound = "";
  
  infoSheet.getDataRange().clear();
  infoSheet.appendRow([colName, "Name", "Grade", "Email", "Phone", "T-Shirt Size"])
  infoSheet.getDataRange().setFontWeight("bold");
  
  for (i in listData) {
    
    role = listData[i][0].toString();
    nameList = listData[i][1].toString().split(", ");
    
    for (k in nameList) {
      
      firstNlast = nameList[k].toString().split(" ");
      row = findStu(firstNlast[0], firstNlast[1], regData);
      
      if (row > -1 && usedNameList.indexOf(nameList[k]) == -1) {
        
        usedNameList.push(nameList[k]);
        infoSheet.appendRow([role, nameList[k], regData[row][4], regData[row][5], regData[row][6], regData[row][11]]);
        
      } else if (usedNameList.indexOf(nameList[k]) != -1) {
      } else {
        
        infoSheet.appendRow([role, nameList[k]]);
        
      }
      
    } 
  }
  
  infoSheet.getDataRange().setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP);
  SpreadsheetApp.setActiveSheet(SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Cast Info"));
  return notFound.slice(0, notFound.length-2);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function findStu(firstName, lastName, data) {
  
  for (i in data) {
    if (data[i][1].trim() == firstName.trim() && data[i][2].trim() == lastName.trim()) {   
      return i;     
    } 
  }
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function createEmailSidebar() {
  
  var ui = HtmlService.createHtmlOutputFromFile("sendemail").setTitle("Send Email");
  SpreadsheetApp.getUi().showSidebar(ui);
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function emailList(infoSheet) {
  
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(infoSheet);
  var ui = SpreadsheetApp.getUi();
  
  var emailList = "";
  var data = sheet.getDataRange().getValues();
  data = data.slice(1, data.length);
  
  for (i in data) {
    var emailAddress = data[i][3];
    emailList = emailList + emailAddress + ", ";
  }
  
  emailList = emailList.slice(0, emailList.length - 2);
  //Logger.log(emailList);
  //SpreadsheetApp.getUi().alert("Emails", "This is a list of all the recognized emails:\n\n" + emailList, ui.ButtonSet.OK);
  return emailList;
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function sendEmail(infoSheet, subj, msg) {
  var emails = emailList(infoSheet);
  GmailApp.sendEmail(emails, subj, msg);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function countSizes() {
 
  var sheetName = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet().getName();
  var ui = SpreadsheetApp.getUi();
  var size;
  var s = 0;
  var m = 0;
  var l = 0;
  var xl = 0;
  var total;
  var data;
  
  if (sheetName.slice(0,4) == "Cast") {
    data = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Cast Info").getDataRange().getValues();
  } else if (sheetName.slice(0,4) == "Crew") {
    data = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Crew Info").getDataRange().getValues();
  }
  
  for (i in data) {
    
    size = data[i][5];
    
    switch (size) {
      case "S":
        s++;
        break;
      case "M":
        m++;
        break;
      case "L":
        l++;
        break;
      case "XL":
        xl++;
        break;
    }
    
  }
  
  total = s + m + l + xl;
  
  ui.alert(sheetName.slice(0,4)+" Shirt Sizes", "Small: " + s + "\nMedium: " + m + "\nLarge: " + l + "\nExtra Large: " + xl + "\n\nTotal: " + total, ui.ButtonSet.OK)
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function phoneList() {
  
  var sheetName = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet().getName();
  var ui = SpreadsheetApp.getUi();
  
  function genPhoneList(sheetName) {
    
    var data = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName).getDataRange().getValues();
    var phoneList = "";
    
    data = data.slice(1, data.length);
    
    for (i in data) {
      var phoneNum = data[i][4];
      if (phoneNum.toString().length > 0) {
        phoneList = phoneList + phoneNum.toString() + ", ";
      }
    }
    
    phoneList = phoneList.slice(0, phoneList.length - 2);
    SpreadsheetApp.getUi().alert(sheetName.slice(0, 4)+" Phone Numbers", "This is a list of all the recognized phone numbers:\n\n" + phoneList, ui.ButtonSet.OK);
    
  }
  
  genPhoneList("Cast Info");
  genPhoneList("Crew Info");
  
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
